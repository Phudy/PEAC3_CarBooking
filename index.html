<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองรถยนต์ - กบฟ. กฟก.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        violet: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        },
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(124, 58, 237, 0.3)',
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc; /* Slate-50 equivalent */
            color: #1e293b; /* Slate-800 */
        }
        
        /* Luxury Gradient Background */
        .bg-luxury {
            background: radial-gradient(circle at 50% 0%, rgba(124, 58, 237, 0.08) 0%, rgba(255, 255, 255, 0) 70%);
        }

        .pea-gradient { 
            background: linear-gradient(135deg, #7c3aed 0%, #c026d3 100%); 
        }
        
        /* Enhanced Glassmorphism */
        .glass-header { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        /* Modern Card */
        .modern-card { 
            background: white; 
            border-radius: 1.25rem; 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(241, 245, 249, 0.8);
            position: relative;
            overflow: hidden;
        }
        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #7c3aed, #c026d3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modern-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01); 
        }
        .modern-card:hover::before {
            opacity: 1;
        }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { 
            min-height: 100px; 
            border-radius: 1rem; 
            transition: all 0.2s; 
            background: #fff;
            border: 1px solid #f1f5f9;
        }
        .calendar-day:hover { 
            background-color: #f8fafc; 
            border-color: #e2e8f0;
            transform: scale(1.02);
        }

        /* Status Pills with more subtle colors */
        .status-pill { @apply px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2 border shadow-sm; }
        .status-pending { @apply bg-amber-50 text-amber-700 border-amber-100; }
        .status-approved { @apply bg-emerald-50 text-emerald-700 border-emerald-100; }
        .status-rejected { @apply bg-rose-50 text-rose-700 border-rose-100; }
        .status-parking { @apply bg-indigo-50 text-indigo-700 border-indigo-100; }
        .status-completed { @apply bg-slate-50 text-slate-600 border-slate-200; }

        /* Animation */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal-backdrop { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(15, 23, 42, 0.4); /* Slate-900 with opacity */
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; 
            z-index: 50; opacity: 0; visibility: hidden; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .modal-content { 
            background: rgba(255, 255, 255, 0.95); /* Slight transparency */
            padding: 2.5rem; 
            border-radius: 2rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            transform: scale(0.95) translateY(20px); 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            width: 95%; max-width: 850px; 
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-backdrop.active .modal-content { transform: scale(1) translateY(0); }

        /* Inputs */
        .modern-input { 
            @apply block w-full rounded-xl border-slate-200 bg-slate-50/50 shadow-sm focus:border-violet-500 focus:bg-white focus:ring-violet-500 transition-all duration-300 hover:bg-white; 
        }
        
        /* Navigation */
        .nav-link { 
            @apply px-5 py-2.5 text-base font-medium rounded-xl transition-all duration-300; 
        }
        .nav-link.active { 
            @apply bg-violet-600 text-white shadow-lg shadow-violet-500/30; 
        }
        .nav-link:not(.active) { 
            @apply text-slate-500 hover:bg-white hover:text-slate-900 hover:shadow-sm; 
        }

        /* Buttons */
        .btn-primary {
            @apply text-white bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 shadow-lg shadow-violet-500/30 hover:shadow-violet-500/40 transition-all duration-300 active:scale-95 rounded-xl;
        }

        /* Map & Pins */
        #parkingMapContainer { position: relative; cursor: crosshair; border-radius: 1.5rem; overflow: hidden; box-shadow: inset 0 2px 10px 0 rgba(0, 0, 0, 0.05); border: 4px solid white; }
        #parkingPin { position: absolute; transform: translate(-50%, -100%); pointer-events: none; display: none; z-index: 20; }
        .car-pin { position: absolute; transform: translate(-50%, -100%); cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; align-items: center; z-index: 10; }
        .car-pin-label { 
            margin-top: 4px; 
            background-color: rgba(255, 255, 255, 0.95); 
            color: #475569; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600; 
            white-space: nowrap; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            border: 1px solid #f1f5f9;
            backdrop-filter: blur(4px);
        }
        .car-pin:hover { transform: translate(-50%, -100%) scale(1.2); z-index: 30; }

        .input-with-icon { position: relative; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; transition: color 0.3s; }
        .input-with-icon:focus-within .input-icon { color: #7c3aed; }
        .input-with-icon input, .input-with-icon textarea, .input-with-icon select { padding-left: 3rem; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 100; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 16px 24px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); 
            display: flex; items-center; gap: 12px; 
            transform: translateX(120%); 
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); 
            border: 1px solid rgba(255,255,255,0.5);
            min-width: 320px;
            pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 4px solid #10b981; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-icon { width: 24px; height: 24px; flex-shrink: 0; }
        .toast-success .toast-icon { color: #10b981; }
        .toast-error .toast-icon { color: #ef4444; }

        @media print {
            body * { visibility: hidden; }
            #print-container, #print-area, #print-area * { visibility: visible; }
            #print-container { position: fixed; left: 0; top: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-start; background: white; }
            #print-area { width: 210mm; height: 148.5mm; box-sizing: border-box; overflow: hidden; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body class="min-h-screen pb-10 bg-luxury relative selection:bg-violet-200 selection:text-violet-900">
    
    <!-- Ambient Background Glow -->
    <div class="fixed inset-0 -z-10 pointer-events-none overflow-hidden">
        <div class="absolute -top-[20%] left-1/2 -translate-x-1/2 w-[1000px] h-[600px] bg-violet-200/20 rounded-full blur-[120px]"></div>
        <div class="absolute top-[20%] -right-[10%] w-[600px] h-[600px] bg-fuchsia-100/30 rounded-full blur-[100px]"></div>
    </div>

    <div id="app"></div>
    
    <div id="print-container" class="hidden print:flex">
        <div id="print-area"></div>
    </div>

    <div id="toast-container"></div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-slate-100">
                <div>
                    <h2 id="modalTitle" class="text-2xl font-bold text-slate-800">สร้างคำขอจองรถยนต์</h2>
                    <p class="text-sm text-slate-500 mt-1">กรอกรายละเอียดการเดินทางและการใช้งาน</p>
                </div>
                <button type="button" onclick="document.getElementById('bookingModal').classList.remove('active')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="bookingForm">
                <input type="hidden" id="bookingId">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <!-- Left Column -->
                    <div class="space-y-8">
                        <div>
                             <h3 class="text-sm font-bold text-violet-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <span class="w-6 h-6 rounded-md bg-violet-100 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></span>
                                ข้อมูลเบื้องต้น
                             </h3>
                             <div class="space-y-5">
                                 <div class="input-with-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd" /></svg>
                                    <input type="text" id="orderNumber" class="modern-input" required placeholder="เลขที่คำสั่ง">
                                </div>
                                <div class="input-with-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                    <input type="text" id="fullName" class="modern-input" required placeholder="ชื่อ-นามสกุล">
                                </div>
                                <div class="input-with-icon">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg>
                                    <input type="text" id="department" class="modern-input" required placeholder="แผนก">
                                </div>
                             </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-violet-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                                <span class="w-6 h-6 rounded-md bg-violet-100 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></span>
                                การเดินทาง
                            </h3>
                            <div class="space-y-5">
                                <div class="input-with-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                    <input type="text" id="destination" class="modern-input" required placeholder="สถานที่ไปปฏิบัติงาน">
                                </div>
                                <div class="input-with-icon">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    <textarea id="purpose" rows="2" class="modern-input" required placeholder="เรื่องที่ไปปฏิบัติงาน"></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                        <label class="text-xs text-slate-500 font-bold uppercase tracking-wide mb-2 block">เวลาไป</label>
                                        <div class="flex gap-2">
                                            <input type="date" id="startDate" class="booking-datetime-picker text-sm w-full outline-none text-slate-700 bg-transparent font-medium" required>
                                            <select id="startTime" class="booking-datetime-picker text-sm outline-none text-slate-700 bg-transparent font-medium" required></select>
                                        </div>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                        <label class="text-xs text-slate-500 font-bold uppercase tracking-wide mb-2 block">เวลากลับ</label>
                                        <div class="flex gap-2">
                                            <input type="date" id="endDate" class="booking-datetime-picker text-sm w-full outline-none text-slate-700 bg-transparent font-medium" required>
                                            <select id="endTime" class="booking-datetime-picker text-sm outline-none text-slate-700 bg-transparent font-medium" required></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="flex flex-col">
                        <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4">เลือกรถยนต์</h3>
                        <div id="carSelectionList" class="flex-grow space-y-3 overflow-y-auto pr-2 max-h-[500px]">
                            <!-- Car list populated via JS -->
                        </div>
                        <p id="carSelectionError" class="text-rose-500 text-sm mt-3 hidden font-medium animate-pulse bg-rose-50 p-2 rounded-lg text-center border border-rose-100">กรุณาเลือกรถยนต์</p>
                        
                        <div class="mt-auto pt-6 border-t border-slate-100 flex justify-end gap-4">
                            <button type="button" id="closeBookingModalBtn" class="px-6 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-100 transition-colors">ยกเลิก</button>
                            <button type="submit" class="btn-primary px-8 py-3 text-sm font-semibold">บันทึกข้อมูล</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Car Management Modal -->
     <div id="carModal" class="modal-backdrop">
         <div class="modal-content" style="max-width: 500px;">
            <h2 id="carModalTitle" class="text-2xl font-bold text-slate-800 mb-6">จัดการรถยนต์</h2>
            <form id="carForm">
                <input type="hidden" id="carId">
                <div class="space-y-6">
                    <div class="input-with-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm14 1H4v8h12V6z" clip-rule="evenodd" /></svg>
                        <input type="text" id="carLicense" class="modern-input" required placeholder="ทะเบียนรถ (เช่น 1กข 1234)">
                    </div>
                    <div class="input-with-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" /></svg>
                        <input type="text" id="carName" class="modern-input" required placeholder="ยี่ห้อ/รุ่น (เช่น Toyota Hilux)">
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" id="closeCarModalBtn" class="px-6 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-colors font-medium">ยกเลิก</button>
                    <button type="submit" class="btn-primary px-8 py-2.5 font-medium">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Parking Modal -->
    <div id="parkingModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ระบุตำแหน่งที่จอดรถ</h2>
            <p class="text-slate-500 mb-6 text-base">คลิกบนแผนที่เพื่อระบุจุดที่จอด และกรอกเลขไมล์ปัจจุบัน</p>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-slate-700 mb-2">เลขไมล์ปัจจุบัน (กม.)</label>
                <div class="input-with-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                    <input type="number" id="currentMileage" class="modern-input" placeholder="เช่น 12500">
                </div>
            </div>

            <div id="parkingMapContainer" class="bg-slate-100 relative group w-full aspect-[4/3] cursor-crosshair">
                <img id="parkingMapImg" src="" alt="Parking Map" class="w-full h-full object-cover">
                <div id="parkingPin">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-12 h-12 text-rose-600 drop-shadow-xl filter"><path fill="currentColor" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6C372.3 104.6 360.2 96 346.6 96H165.4c-13.6 0-25.7 8.6-30.2 21.4zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V416c0 35.3-28.7 64-64 64H80c-35.3 0-64-28.7-64-64V256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 0a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>
                </div>
                <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/5 transition-colors pointer-events-none"></div>
            </div>
             <div class="mt-8 flex justify-end gap-3">
                <input type="hidden" id="parkingBookingId">
                <button type="button" id="closeParkingModalBtn" class="px-6 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-colors font-medium">ยกเลิก</button>
                <button type="button" id="confirmParkingBtn" class="btn-primary px-8 py-2.5 font-medium disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" disabled>ยืนยันตำแหน่ง</button>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 600px;">
             <h2 class="text-2xl font-bold text-slate-800 mb-6">ข้อมูลการจองรถ</h2>
             <div id="detailsCanvasContainer" class="flex justify-center items-center bg-slate-50 p-6 rounded-3xl border border-slate-200 shadow-inner">
                <canvas id="detailsCanvas" class="rounded-xl shadow-lg max-w-full h-auto"></canvas>
             </div>
             <div class="mt-8 flex justify-between items-center">
                <button type="button" id="closeDetailsModalBtn" class="px-6 py-2.5 rounded-xl text-slate-600 hover:bg-slate-100 transition-colors font-medium">ปิด</button>
                <a id="downloadDetailsLink" href="#" download="booking-info.png" class="btn-primary px-6 py-2.5 font-medium flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    ดาวน์โหลดรูปภาพ
                </a>
             </div>
        </div>
    </div>


    <script type="module">
        // --- STATE MANAGEMENT ---
        const state = {
            currentUser: { id: 'user001', name: 'พนักงานทั่วไป', role: 'user' },
            parkingMapImage: `https://i.postimg.cc/2jWG285V/216784.jpg`,
            cars: [
                { id: 'car1', name: 'Toyota Hilux Revo', license: '1กข 1234 นครปฐม', lastParkingLocation: { x: 55.5, y: 34.2, date: '2025-09-11', mileage: 12050 } },
                { id: 'car2', name: 'Isuzu D-Max', license: '2ฒฮ 5678 กรุงเทพมหานคร', lastParkingLocation: null },
                { id: 'car3', name: 'Toyota Yaris Ativ', license: '3ขง 9101 นครปฐม', lastParkingLocation: null },
                { id: 'car4', name: 'Honda City', license: '4กก 1121 กรุงเทพมหานคร', lastParkingLocation: { x: 70, y: 80, date: '2025-09-15', mileage: 5400 } }
            ],
            bookings: [
                { id: 'b001', carId: 'car1', userId: 'user002', userName: 'สมชาย ใจดี', department: 'แผนกบัญชี', orderNumber: 'ค.12/2568', destination: 'กฟภ. อ.สามพราน', purpose: 'ตรวจสอบมิเตอร์', startDate: '2025-09-10', startTime: '09:00', endDate: '2025-09-11', endTime: '17:00', status: 'approved', parkingLocation: { x: 55.5, y: 34.2 } },
                { id: 'b002', carId: 'car3', userId: 'user003', userName: 'สมหญิง จริงใจ', department: 'แผนกเศรษฐกิจพลังงาน', orderNumber: 'ค.15/2568', destination: 'สำนักงานใหญ่ กทม.', purpose: 'ประชุม', startDate: '2025-10-15', startTime: '08:30', endDate: '2025-10-16', endTime: '16:30', status: 'pending' },
                { id: 'b003', carId: 'car1', userId: 'user004', userName: 'มานะ อดทน', department: 'แผนกบัญชี', orderNumber: 'ค.18/2568', destination: 'กฟภ. จ.กาญจนบุรี', purpose: 'อบรม', startDate: '2025-09-20', startTime: '08:00', endDate: '2025-09-22', endTime: '18:00', status: 'rejected' },
                { id: 'b005', carId: 'car4', userId: 'user001', userName: 'พนักงานทั่วไป', department: 'แผนกเศรษฐกิจพลังงาน', orderNumber: 'ค.19/2568', destination: 'กฟภ. จ.ราชบุรี', purpose: 'รับเช็ค', startDate: '2025-09-26', startTime: '10:00', endDate: '2025-09-26', endTime: '12:00', status: 'approved' },
            ],
            currentDate: new Date(),
            currentView: 'dashboard',
            tempParking: { bookingId: null, location: null },
            editingParkingForCarId: null,
            searchQuery: ''
        };

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');
        // ... (Other DOM elements selected inside render/functions for simplicity or globally) ...
        const detailsModal = document.getElementById('detailsModal');
        const detailsCanvas = document.getElementById('detailsCanvas');
        const downloadDetailsLink = document.getElementById('downloadDetailsLink');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
        
        // --- TOAST SYSTEM ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconSvg = type === 'success' 
                ? '<svg class="toast-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' 
                : '<svg class="toast-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';
            
            toast.innerHTML = `${iconSvg}<p class="font-medium text-slate-700 text-sm">${message}</p>`;
            container.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.add('show'));
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- UTILITY FUNCTIONS ---
        const formatDateTime = (date, time) => {
            if (!date || !time) return 'N/A';
            const d = new Date(`${date}T${time}`);
            return new Intl.DateTimeFormat('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).format(d) + ' น.';
        }

        const isCarAvailable = (carId, checkStart, checkEnd) => {
            if (!checkStart || !checkEnd || checkStart >= checkEnd) return false;
            const conflictingBooking = state.bookings.find(booking => {
                if (booking.status !== 'approved' || booking.carId !== carId) return false;
                const bookingStart = new Date(`${booking.startDate}T${booking.startTime}`);
                const bookingEnd = new Date(`${booking.endDate}T${booking.endTime}`);
                return checkStart < bookingEnd && checkEnd > bookingStart;
            });
            return !conflictingBooking;
        };
        
        const isCarAvailableNow = (carId) => {
            const now = new Date();
            const conflictingBooking = state.bookings.find(booking => {
                if (booking.status !== 'approved' || booking.carId !== carId) return false;
                const bookingStart = new Date(`${booking.startDate}T${booking.startTime}`);
                const bookingEnd = new Date(`${booking.endDate}T${booking.endTime}`);
                return now >= bookingStart && now <= bookingEnd;
            });
            return !conflictingBooking;
        };

        const getBookingDisplayStatus = (booking) => {
            const now = new Date();
            const todayDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startDate = new Date(booking.startDate);

            switch (booking.status) {
                case 'pending': return { text: 'รออนุมัติ', color: 'pending' };
                case 'rejected': return { text: 'ไม่อนุมัติ', color: 'rejected' };
                case 'approved':
                    if (booking.parkingLocation) return { text: 'เสร็จสิ้น', color: 'completed' };
                    if (todayDateOnly >= startDate) return { text: 'รอระบุที่จอด', color: 'parking' };
                    return { text: 'อนุมัติแล้ว', color: 'approved' };
                default: return { text: 'ไม่ระบุ', color: 'gray' };
            }
        };
        
        const isHistory = (booking) => {
            const displayStatus = getBookingDisplayStatus(booking);
            if (displayStatus.color !== 'completed') return false;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const endDate = new Date(booking.endDate);
            return endDate < today;
        };

        function getCalendarInfo(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            return { year, month, daysInMonth, firstDayOfMonth };
        }

        function generateTimeOptions(selectElement) {
            let options = '';
            for (let h = 7; h <= 19; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = h.toString().padStart(2, '0');
                    const minute = m.toString().padStart(2, '0');
                    const time = `${hour}:${minute}`;
                    options += `<option value="${time}">${time} น.</option>`;
                }
            }
            selectElement.innerHTML = options;
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            let viewContent = '';
            switch(state.currentView) {
                case 'dashboard': viewContent = renderDashboard(); break;
                case 'calendar': viewContent = renderCalendarView(); break;
                case 'parking': viewContent = renderParkingMapView(); break;
                case 'history': viewContent = renderHistoryView(); break;
            }
            app.innerHTML = `${renderHeader()}<main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">${viewContent}</main>`;
            addEventListeners();
        }

        function renderHeader() {
            const roleText = state.currentUser.role === 'user' ? 'พนักงาน' : 'รองผู้อำนวยการ (ผู้อนุมัติ)';
            return `
                <header class="glass-header sticky top-0 z-40">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-20">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-xl pea-gradient flex items-center justify-center text-white shadow-lg shadow-violet-500/20 transform transition-transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" /></svg>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold text-slate-800 leading-none tracking-tight">Car Booking</h1>
                                    <p class="text-xs text-slate-500 font-medium mt-1">กบฟ. กฟก.3 นครปฐม</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-6">
                                <nav class="hidden md:flex space-x-2">
                                    <button data-view="dashboard" class="nav-link ${state.currentView === 'dashboard' ? 'active' : ''}">แดชบอร์ด</button>
                                    <button data-view="calendar" class="nav-link ${state.currentView === 'calendar' ? 'active' : ''}">ปฏิทิน</button>
                                    <button data-view="parking" class="nav-link ${state.currentView === 'parking' ? 'active' : ''}">ที่จอดรถ</button>
                                    <button data-view="history" class="nav-link ${state.currentView === 'history' ? 'active' : ''}">ประวัติ</button>
                                </nav>
                                <div class="flex items-center gap-4 pl-6 border-l border-slate-200/50">
                                    <div class="text-right hidden sm:block">
                                        <p class="text-sm font-bold text-slate-800">${state.currentUser.name}</p>
                                        <p class="text-xs text-violet-600 font-bold bg-violet-50 px-2.5 py-0.5 rounded-full inline-block border border-violet-100">${roleText}</p>
                                    </div>
                                    <button id="toggleRoleBtn" class="bg-white shadow-sm border border-slate-200 hover:bg-slate-50 p-2.5 rounded-full transition-all text-slate-600 hover:text-violet-600" title="สลับบทบาท">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Mobile Nav -->
                        <div class="flex md:hidden space-x-2 pb-4 overflow-x-auto no-scrollbar px-2">
                             <button data-view="dashboard" class="nav-link whitespace-nowrap text-sm ${state.currentView === 'dashboard' ? 'active' : ''}">แดชบอร์ด</button>
                             <button data-view="calendar" class="nav-link whitespace-nowrap text-sm ${state.currentView === 'calendar' ? 'active' : ''}">ปฏิทิน</button>
                             <button data-view="parking" class="nav-link whitespace-nowrap text-sm ${state.currentView === 'parking' ? 'active' : ''}">ที่จอดรถ</button>
                             <button data-view="history" class="nav-link whitespace-nowrap text-sm ${state.currentView === 'history' ? 'active' : ''}">ประวัติ</button>
                        </div>
                    </div>
                </header>`;
        }

        function renderDashboard() {
            return state.currentUser.role === 'user' ? renderUserDashboard() : renderApproverDashboard();
        }

        function renderSearchInput() {
            return `
            <div class="relative mb-8">
                <input type="text" id="searchInput" class="block w-full pl-12 pr-4 py-3 border-none bg-white rounded-2xl text-base focus:outline-none focus:ring-2 focus:ring-violet-500/50 shadow-sm transition-shadow placeholder-slate-400 text-slate-700" placeholder="ค้นหาจาก ทะเบียน, ชื่อผู้จอง หรือเลขคำสั่ง..." value="${state.searchQuery}">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>`;
        }

        function filterBookings(bookings) {
            if (!state.searchQuery) return bookings;
            const query = state.searchQuery.toLowerCase();
            return bookings.filter(b => 
                b.userName.toLowerCase().includes(query) || 
                b.orderNumber.toLowerCase().includes(query) ||
                (state.cars.find(c => c.id === b.carId)?.license.toLowerCase().includes(query))
            );
        }

        function renderUserDashboard() {
            let myBookings = state.bookings.filter(b => b.userId === state.currentUser.id && !isHistory(b)).sort((a,b) => new Date(`${b.startDate}T${b.startTime}`) - new Date(`${a.startDate}T${a.startTime}`));
            myBookings = filterBookings(myBookings);

            return `
            <div class="fade-in grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="modern-card p-8">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">การจองปัจจุบัน</h2>
                                <p class="text-sm text-slate-500 mt-1">รายการจองที่กำลังดำเนินการ</p>
                            </div>
                            <button id="newBookingBtn" class="btn-primary px-6 py-2.5 text-sm font-bold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                <span>จองรถใหม่</span>
                            </button>
                        </div>
                        ${renderSearchInput()}
                        <div class="space-y-5">
                            ${myBookings.length > 0 ? myBookings.map(renderBookingCard).join('') : 
                            `<div class="text-center py-16 bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                                </div>
                                <p class="text-slate-500 font-medium">ไม่มีรายการจองที่ตรงกัน</p>
                            </div>`}
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1">
                     <div class="modern-card p-6 sticky top-24">
                        <h2 class="text-xl font-bold text-slate-800 mb-1">สถานะรถยนต์</h2>
                        <p class="text-sm text-slate-500 mb-6">อัปเดตล่าสุดวันนี้</p>
                        <ul class="space-y-3">
                            ${state.cars.map(car => `
                            <li class="flex items-center justify-between p-4 rounded-2xl hover:bg-slate-50/80 transition-all border border-transparent hover:border-slate-100">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-white border border-slate-100 text-violet-500 rounded-xl flex items-center justify-center shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" /></svg>
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-800 text-sm">${car.license}</p>
                                        <p class="text-xs text-slate-500 font-medium">${car.name}</p>
                                    </div>
                                </div>
                                ${ isCarAvailableNow(car.id)
                                    ? '<span class="px-3 py-1 rounded-full text-[10px] font-bold bg-emerald-100 text-emerald-600 border border-emerald-200">ว่าง</span>'
                                    : '<span class="px-3 py-1 rounded-full text-[10px] font-bold bg-rose-100 text-rose-600 border border-rose-200">ไม่ว่าง</span>'
                                }
                            </li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>`;
        }

        function renderApproverDashboard() {
             let allBookings = [...state.bookings].filter(b => !isHistory(b)).sort((a,b) => new Date(`${b.startDate}T${b.startTime}`) - new Date(`${a.startDate}T${a.startTime}`));
             allBookings = filterBookings(allBookings);
             
             const pendingCount = state.bookings.filter(b => b.status === 'pending').length;
             const activeCarsCount = state.cars.filter(c => !isCarAvailableNow(c.id)).length;

            return `
            <div class="fade-in grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <!-- Admin Stats -->
                    <div class="grid grid-cols-2 gap-5 mb-8">
                        <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-100 flex items-center gap-5">
                            <div class="w-12 h-12 rounded-2xl bg-amber-50 text-amber-500 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wide">รออนุมัติ</p>
                                <p class="text-2xl font-bold text-slate-800 mt-0.5">${pendingCount} <span class="text-sm font-normal text-slate-400">รายการ</span></p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-card border border-slate-100 flex items-center gap-5">
                            <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-500 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wide">รถที่กำลังใช้งาน</p>
                                <p class="text-2xl font-bold text-slate-800 mt-0.5">${activeCarsCount} <span class="text-sm font-normal text-slate-400">คัน</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="modern-card p-8">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">รายการคำขอ</h2>
                            <p class="text-sm text-slate-500 mt-1">จัดการคำขอจองรถทั้งหมด (${allBookings.length})</p>
                        </div>
                        ${renderSearchInput()}
                        <div class="space-y-5">
                            ${allBookings.length > 0 ? allBookings.map(renderBookingCard).join('') : 
                            `<div class="text-center py-16 bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200">
                                <p class="text-slate-500 font-medium">ไม่มีคำขอในขณะนี้</p>
                            </div>`}
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1">
                     <div class="modern-card p-6 sticky top-24">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-slate-800">จัดการรถยนต์</h2>
                            <button id="addCarBtn" class="bg-violet-50 text-violet-700 hover:bg-violet-100 px-4 py-2 rounded-xl text-xs font-bold transition-colors flex items-center gap-1.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                <span>เพิ่ม</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${state.cars.map(car => `
                            <div class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 hover:bg-white hover:shadow-card transition-all border border-transparent hover:border-slate-100 group">
                                <div>
                                    <p class="font-bold text-slate-800 text-sm">${car.license}</p>
                                    <p class="text-xs text-slate-500 font-medium">${car.name}</p>
                                </div>
                                <div class="flex space-x-1 opacity-40 group-hover:opacity-100 transition-opacity">
                                     <button data-id="${car.id}" class="edit-parking-btn p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-xl transition-colors" title="แก้ไขตำแหน่งจอด">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button data-id="${car.id}" class="edit-car-btn p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors" title="แก้ไขข้อมูลรถ">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button data-id="${car.id}" class="delete-car-btn p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-xl transition-colors" title="ลบรถ">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderBookingCard(booking) {
            const car = state.cars.find(c => c.id === booking.carId);
            if (!car) return '';
            const displayStatus = getBookingDisplayStatus(booking);
            let actionArea = '';

            if (state.currentUser.role === 'approver' && booking.status === 'pending') {
                actionArea = `
                <div class="flex items-center gap-3 mt-4 pt-4 border-t border-slate-100">
                    <button data-id="${booking.id}" class="approve-btn flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm hover:shadow-md">อนุมัติ</button>
                    <button data-id="${booking.id}" class="reject-btn flex-1 bg-white border border-rose-200 hover:bg-rose-50 text-rose-600 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all">ไม่อนุมัติ</button>
                </div>`;
            } else if (state.currentUser.role === 'user') {
                 switch (displayStatus.color) {
                    case 'parking':
                        actionArea = `
                        <div class="flex items-center gap-3 mt-4 pt-4 border-t border-slate-100">
                            <button data-id="${booking.id}" class="park-car-btn w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 transition-all flex justify-center items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                ระบุที่จอด
                            </button>
                        </div>`;
                        break;
                    case 'approved':
                        actionArea = `
                        <div class="flex items-center gap-3 mt-4 pt-4 border-t border-slate-100">
                            <button data-id="${booking.id}" class="view-details-btn flex-1 bg-slate-50 hover:bg-white border border-slate-100 hover:border-slate-200 text-slate-600 px-3 py-2.5 rounded-xl text-sm font-semibold transition-all flex justify-center items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                รายละเอียด
                            </button>
                            <button data-id="${booking.id}" class="print-pass-btn flex-1 bg-teal-500 hover:bg-teal-600 text-white px-3 py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-teal-500/20 transition-all flex justify-center items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H5V9h10v3z" clip-rule="evenodd" /></svg>
                                พิมพ์ใบรถ
                            </button>
                        </div>`;
                        break;
                    case 'completed':
                        actionArea = ``; 
                        break;
                    case 'rejected':
                        actionArea = `
                        <div class="flex items-center gap-3 mt-4 pt-4 border-t border-slate-100">
                            <button data-id="${booking.id}" class="edit-booking-btn flex-1 bg-amber-50 hover:bg-amber-100 text-amber-700 border border-amber-100 px-3 py-2.5 rounded-xl text-sm font-semibold transition-colors">แก้ไข</button>
                            <button data-id="${booking.id}" class="delete-booking-btn flex-1 bg-white border border-rose-200 hover:bg-rose-50 text-rose-600 px-3 py-2.5 rounded-xl text-sm font-semibold transition-colors">ลบ</button>
                        </div>`;
                        break;
                }
            }

            const badgeColorMap = { pending: 'status-pending', approved: 'status-approved', rejected: 'status-rejected', parking: 'status-parking', completed: 'status-completed' };
            const badgeClass = badgeColorMap[displayStatus.color] || 'status-completed';
            
            const badgeDotColors = { pending: 'bg-amber-400', approved: 'bg-emerald-400', rejected: 'bg-rose-400', parking: 'bg-indigo-400', completed: 'bg-slate-400' };
            const dotClass = badgeDotColors[displayStatus.color] || 'bg-slate-400';

            return `
                <div class="bg-white border border-slate-100 rounded-[1.25rem] p-6 hover:shadow-card transition-all duration-300 group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-violet-50 text-violet-600 flex items-center justify-center font-bold text-sm border border-violet-100 shadow-sm">
                                ${car.license.split(' ')[0]}
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-base">${car.license}</p>
                                <p class="text-xs text-slate-500 font-medium">${car.name}</p>
                            </div>
                        </div>
                        <span class="status-pill ${badgeClass}">
                            <span class="w-2 h-2 rounded-full ${dotClass}"></span>
                            ${displayStatus.text}
                        </span>
                    </div>
                    
                    <div class="space-y-3 mb-2">
                        <div class="flex items-start gap-3 text-sm text-slate-600">
                            <div class="w-5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></div>
                            <span class="font-medium">${booking.userName} <span class="text-xs text-slate-400 font-normal">(${booking.department || '-'})</span></span>
                        </div>
                        <div class="flex items-start gap-3 text-sm text-slate-600">
                            <div class="w-5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></div>
                            <span class="truncate font-medium" title="${booking.destination}">${booking.destination}</span>
                        </div>
                        <div class="flex items-start gap-3 text-sm text-slate-600">
                            <div class="w-5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg></div>
                            <span class="text-xs bg-slate-50 px-2.5 py-1 rounded-md border border-slate-100 font-medium text-slate-500">
                                ${formatDateTime(booking.startDate, booking.startTime)} - ${formatDateTime(booking.endDate, booking.endTime)}
                            </span>
                        </div>
                         <div class="flex items-start gap-3 text-sm text-slate-500 mt-2 pt-2 border-t border-slate-50/50">
                            <div class="w-5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></div>
                            <span class="truncate italic" title="${booking.purpose}">"${booking.purpose}"</span>
                        </div>
                    </div>
                    
                    ${actionArea}
                </div>`;
        }

        function renderCalendarView() {
            const { year, month, daysInMonth, firstDayOfMonth } = getCalendarInfo(state.currentDate);
            let dayCells = '';
            for (let i = 0; i < firstDayOfMonth; i++) { dayCells += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const bookingsForDay = state.bookings.filter(b => b.status === 'approved' && dateStr >= b.startDate && dateStr <= b.endDate);
                
                let bookingDots = '';
                if (bookingsForDay.length > 0) {
                    bookingDots = bookingsForDay.map(b => {
                         const car = state.cars.find(c => c.id === b.carId);
                         return `<div class="text-[10px] px-2 py-1 rounded-lg bg-violet-50 text-violet-700 border border-violet-100 truncate mb-1 font-medium shadow-sm">${car?.license}</div>`;
                    }).join('');
                }

                dayCells += `
                <div class="calendar-day bg-white border border-slate-100 p-3 hover:shadow-card hover:border-violet-100 transition-all flex flex-col group">
                    <div class="font-bold text-slate-700 text-sm mb-2 group-hover:text-violet-600 transition-colors">${day}</div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar space-y-1">
                        ${bookingDots}
                    </div>
                </div>`;
            }
            return `
            <div class="modern-card p-8 fade-in">
                <div class="flex justify-between items-center mb-8">
                    <button id="prevMonth" class="p-2.5 rounded-xl hover:bg-slate-100 text-slate-600 transition-colors border border-transparent hover:border-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                    <h2 class="text-2xl font-bold text-slate-800 tracking-tight">${new Intl.DateTimeFormat('th-TH', { month: 'long', year: 'numeric' }).format(state.currentDate)}</h2>
                    <button id="nextMonth" class="p-2.5 rounded-xl hover:bg-slate-100 text-slate-600 transition-colors border border-transparent hover:border-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button>
                </div>
                <div class="calendar-grid text-center font-bold text-slate-400 text-xs uppercase tracking-widest mb-4">
                    <div>อา.</div><div>จ.</div><div>อ.</div><div>พ.</div><div>พฤ.</div><div>ศ.</div><div>ส.</div>
                </div>
                <div class="calendar-grid">
                    ${dayCells}
                </div>
            </div>`;
        }

        function renderParkingMapView() {
            const parkedCars = state.cars.filter(c => c.lastParkingLocation);
            return `
                 <div class="modern-card p-8 fade-in">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-slate-800">แผนที่ที่จอดรถ</h2>
                        <p class="text-sm text-slate-500 mt-1">แสดงตำแหน่งจอดล่าสุดของรถแต่ละคัน</p>
                    </div>
                     <div class="relative w-full rounded-3xl overflow-hidden shadow-inner border-4 border-white bg-slate-100">
                        <img src="${state.parkingMapImage}" alt="Parking Map" class="w-full h-auto block">
                        ${parkedCars.map(car => {
                            return `
                                <div class="car-pin" style="left: ${car.lastParkingLocation.x}%; top: ${car.lastParkingLocation.y}%;" title="จอดล่าสุด: ${new Date(car.lastParkingLocation.date).toLocaleString('th-TH')} เลขไมล์: ${car.lastParkingLocation.mileage || '-'} กม.">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-12 h-12 text-violet-600 drop-shadow-xl filter"><path fill="currentColor" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6C372.3 104.6 360.2 96 346.6 96H165.4c-13.6 0-25.7 8.6-30.2 21.4zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V416c0 35.3-28.7 64-64 64H80c-35.3 0-64-28.7-64-64V256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 0a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>
                                    <span class="car-pin-label">${car.license}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderHistoryView() {
            let historyBookings;
            let title;

            if (state.currentUser.role === 'user') {
                historyBookings = state.bookings
                    .filter(b => b.userId === state.currentUser.id && isHistory(b))
                    .sort((a,b) => new Date(`${b.endDate}T${b.endTime}`) - new Date(`${a.endDate}T${a.endTime}`));
                title = "ประวัติการจองของฉัน";
            } else {
                historyBookings = state.bookings
                    .filter(b => isHistory(b))
                    .sort((a,b) => new Date(`${b.endDate}T${b.endTime}`) - new Date(`${a.endDate}T${a.endTime}`));
                title = "ประวัติการจองทั้งหมด";
            }
            
            historyBookings = filterBookings(historyBookings);

            return `
                <div class="modern-card p-8 fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
                            <p class="text-sm text-slate-500 mt-1">รายการที่ดำเนินการเสร็จสิ้นแล้ว (${historyBookings.length})</p>
                        </div>
                    </div>
                    ${renderSearchInput()}
                    <div class="space-y-5">
                        ${historyBookings.length > 0 ? historyBookings.map(renderBookingCard).join('') : 
                        `<div class="text-center py-20 bg-slate-50/50 rounded-3xl border-2 border-dashed border-slate-200">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <p class="text-slate-500 font-medium">ไม่มีประวัติการจอง</p>
                        </div>`}
                    </div>
                </div>
            `;
        }

        // --- LOGIC & EVENT HANDLERS ---
        function addEventListeners() {
            document.getElementById('toggleRoleBtn')?.addEventListener('click', toggleRole);
            document.querySelectorAll('.nav-link').forEach(btn => btn.addEventListener('click', switchView)); 
            document.getElementById('newBookingBtn')?.addEventListener('click', () => openBookingModal());
            // ... (Rest of event listeners)
            document.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', handleApproval));
            document.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', handleApproval));
            document.getElementById('addCarBtn')?.addEventListener('click', () => openCarModal());
            document.querySelectorAll('.edit-car-btn').forEach(btn => btn.addEventListener('click', handleEditCar));
            document.querySelectorAll('.delete-car-btn').forEach(btn => btn.addEventListener('click', handleDeleteCar));
            document.querySelectorAll('.park-car-btn').forEach(btn => btn.addEventListener('click', handleParkCar));
            document.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', handleViewDetails));
            document.getElementById('prevMonth')?.addEventListener('click', changeMonth);
            document.getElementById('nextMonth')?.addEventListener('click', changeMonth);
            document.querySelectorAll('.edit-parking-btn').forEach(btn => btn.addEventListener('click', handleEditParking));
            document.querySelectorAll('.edit-booking-btn').forEach(btn => btn.addEventListener('click', handleEditBooking));
            document.querySelectorAll('.delete-booking-btn').forEach(btn => btn.addEventListener('click', handleDeleteBooking));
            document.querySelectorAll('.print-pass-btn').forEach(btn => btn.addEventListener('click', handlePrintPass));
            document.getElementById('searchInput')?.addEventListener('input', handleSearch);
        }
        
        // ... (Rest of logic functions: handleSearch, changeMonth, etc. remain exactly the same)
        function handleSearch(e) {
            state.searchQuery = e.target.value;
            render();
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                searchInput.focus();
                const val = searchInput.value;
                searchInput.value = '';
                searchInput.value = val;
            }
        }
        
        function changeMonth(e) {
            const newMonth = state.currentDate.getMonth() + (e.currentTarget.id === 'nextMonth' ? 1 : -1);
            state.currentDate.setMonth(newMonth);
            render();
        }

        function updateAvailableCars() {
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;

            if (!startDate || !startTime || !endDate || !endTime) {
                carSelectionList.innerHTML = '<div class="text-center py-12 text-slate-400 bg-slate-50/50 rounded-2xl border border-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p class="text-sm">กรุณาระบุวันและเวลาเดินทาง</p></div>';
                return;
            }

            const checkStart = new Date(`${startDate}T${startTime}`);
            const checkEnd = new Date(`${endDate}T${endTime}`);
            
            if (checkStart >= checkEnd) {
                 carSelectionList.innerHTML = '<div class="p-4 bg-rose-50 text-rose-600 rounded-xl text-sm text-center border border-rose-100 font-medium">เวลาเดินทางกลับต้องอยู่หลังเวลาเดินทางไป</div>';
                 return;
            }

            let listHtml = '';
            state.cars.forEach(car => {
                const available = isCarAvailable(car.id, checkStart, checkEnd);
                listHtml += `
                    <label class="car-select-item flex items-center p-4 rounded-xl border cursor-pointer transition-all ${available ? 'hover:bg-violet-50 border-slate-200 hover:border-violet-200 bg-white' : 'bg-slate-50 border-slate-100 opacity-60'}" data-available="${available}">
                        <div class="relative flex items-center justify-center">
                            <input type="radio" name="car" value="${car.id}" class="peer h-5 w-5 text-violet-600 border-slate-300 focus:ring-violet-500" ${!available ? 'disabled' : ''}>
                        </div>
                        <div class="ml-4 text-sm flex-grow">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-slate-800 text-base">${car.license}</span>
                                <span class="text-[10px] font-bold px-2.5 py-1 rounded-full ${available ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'bg-rose-100 text-rose-700 border border-rose-200'} uppercase tracking-wide">${available ? 'ว่าง' : 'ไม่ว่าง'}</span>
                            </div>
                            <p class="text-slate-500 text-xs mt-0.5">${car.name}</p>
                        </div>
                    </label>
                `;
            });
            carSelectionList.innerHTML = listHtml;
        }
        
        function openBookingModal(bookingToEdit = null) {
            bookingForm.reset();
            document.getElementById('bookingId').value = '';
            
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');
            generateTimeOptions(startTimeSelect);
            generateTimeOptions(endTimeSelect);

            if (bookingToEdit) {
                document.getElementById('modalTitle').textContent = 'แก้ไขคำขอจองรถยนต์';
                document.getElementById('bookingId').value = bookingToEdit.id;
                document.getElementById('orderNumber').value = bookingToEdit.orderNumber;
                document.getElementById('fullName').value = bookingToEdit.userName;
                document.getElementById('department').value = bookingToEdit.department;
                document.getElementById('destination').value = bookingToEdit.destination;
                document.getElementById('purpose').value = bookingToEdit.purpose;
                document.getElementById('startDate').value = bookingToEdit.startDate;
                startTimeSelect.value = bookingToEdit.startTime;
                document.getElementById('endDate').value = bookingToEdit.endDate;
                endTimeSelect.value = bookingToEdit.endTime;
            } else {
                document.getElementById('modalTitle').textContent = 'สร้างคำขอจองรถยนต์';
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                document.getElementById('startDate').value = today;
                startTimeSelect.value = '08:30';
                document.getElementById('endDate').value = today;
                endTimeSelect.value = '16:30';
                document.getElementById('startDate').min = today;
                document.getElementById('endDate').min = today;
                document.getElementById('fullName').value = state.currentUser.name;
            }
            
            updateAvailableCars();
            document.getElementById('bookingModal').classList.add('active');
        }

        function handleBookingFormSubmit(e) {
            e.preventDefault();
            const bookingId = document.getElementById('bookingId').value;
            const selectedCarInput = document.querySelector('input[name="car"]:checked');
            if (!selectedCarInput) {
                const errorEl = document.getElementById('carSelectionError');
                errorEl.classList.remove('hidden');
                return;
            }
            document.getElementById('carSelectionError').classList.add('hidden');
            
            const bookingData = {
                carId: selectedCarInput.value,
                userName: document.getElementById('fullName').value, 
                department: document.getElementById('department').value,
                orderNumber: document.getElementById('orderNumber').value,
                destination: document.getElementById('destination').value, 
                purpose: document.getElementById('purpose').value,
                startDate: document.getElementById('startDate').value, 
                startTime: document.getElementById('startTime').value,
                endDate: document.getElementById('endDate').value, 
                endTime: document.getElementById('endTime').value,
                status: 'pending' 
            };

            if (bookingId) {
                const bookingIndex = state.bookings.findIndex(b => b.id === bookingId);
                if (bookingIndex !== -1) {
                    state.bookings[bookingIndex] = { ...state.bookings[bookingIndex], ...bookingData };
                    showToast('แก้ไขข้อมูลการจองสำเร็จ');
                }
            } else {
                const newBooking = { 
                    ...bookingData, 
                    id: `b${Date.now()}`, 
                    userId: state.currentUser.id 
                };
                state.bookings.push(newBooking);
                showToast('ส่งคำขอจองรถเรียบร้อยแล้ว');
            }

            document.getElementById('bookingModal').classList.remove('active');
            render();
        }

        async function handleViewDetails(e) {
            const bookingId = e.currentTarget.dataset.id;
            const booking = state.bookings.find(b => b.id === bookingId);
            if (!booking) return;

            const car = state.cars.find(c => c.id === booking.carId);
            const canvas = detailsCanvas; const ctx = canvas.getContext('2d');
            const W = 500, H = 700; canvas.width = W; canvas.height = H;
            
            const loadImage = src => new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });

            try {
                ctx.fillStyle = 'white'; ctx.fillRect(0, 0, W, H);
                // Luxury Header for Image
                const gradient = ctx.createLinearGradient(0, 0, W, 0);
                gradient.addColorStop(0, '#7c3aed');
                gradient.addColorStop(1, '#c026d3');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, W, 90);
                
                ctx.fillStyle = 'white'; ctx.font = 'bold 28px Sarabun'; ctx.fillText('ข้อมูลการจองรถยนต์', 30, 55);

                ctx.fillStyle = '#1e293b';
                let y = 140;
                const drawText = (label, value) => {
                    ctx.font = 'bold 16px Sarabun'; ctx.fillStyle = '#64748b'; ctx.fillText(label, 30, y);
                    ctx.font = '500 18px Sarabun'; ctx.fillStyle = '#1e293b'; ctx.fillText(value, 160, y);
                    y += 40;
                };
                drawText('ทะเบียนรถ:', car.license); 
                drawText('ผู้ขอ:', `${booking.userName}`);
                drawText('แผนก:', `${booking.department}`);
                drawText('เลขที่คำสั่ง:', booking.orderNumber); 
                drawText('เดินทาง:', `${formatDateTime(booking.startDate, booking.startTime)}`);
                drawText('ถึง:', `${formatDateTime(booking.endDate, booking.endTime)}`);
                drawText('สถานที่:', booking.destination); 
                drawText('เรื่อง:', booking.purpose);

                y += 20;
                ctx.font = 'bold 18px Sarabun'; ctx.fillStyle = '#7c3aed'; ctx.fillText('ตำแหน่งจอดล่าสุด', 30, y);
                const mapY = y + 20;
                const mapW = W - 60;

                // Map container style on canvas
                ctx.save();
                ctx.beginPath();
                ctx.roundRect(30, mapY, mapW, mapW * 0.6, 15);
                ctx.clip();

                const mapImg = await loadImage(state.parkingMapImage);
                const mapRatio = mapImg.height / mapImg.width;
                const mapH = mapW * mapRatio;
                ctx.drawImage(mapImg, 30, mapY, mapW, mapH);
                ctx.restore(); // Restore clip

                if (car.lastParkingLocation) {
                    const pinX = 30 + (mapW * car.lastParkingLocation.x / 100);
                    const pinY = mapY + (mapH * car.lastParkingLocation.y / 100);
                    // Draw a simple pin manually or load svg
                    const pinSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50"><path fill="#db2777" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6C372.3 104.6 360.2 96 346.6 96H165.4c-13.6 0-25.7 8.6-30.2 21.4zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V416c0 35.3-28.7 64-64 64H80c-35.3 0-64-28.7-64-64V256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 0a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>';
                    const pinImg = await loadImage('data:image/svg+xml;base64,' + btoa(pinSvg));
                    ctx.drawImage(pinImg, pinX - 25, pinY - 50, 50, 50);
                } else {
                     ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(30, mapY, mapW, mapH);
                     ctx.fillStyle = '#94a3b8'; ctx.font = 'bold 20px Sarabun'; ctx.textAlign = 'center';
                     ctx.fillText('ไม่มีข้อมูลตำแหน่งจอดล่าสุด', 30 + mapW/2, mapY + mapH/2);
                     ctx.textAlign = 'left';
                }

            } catch (error) {
                console.error("Error drawing canvas", error);
            }
            
            downloadDetailsLink.href = canvas.toDataURL('image/png');
            detailsModal.classList.add('active');
        }

        function handlePrintPass(e) {
            const bookingId = e.currentTarget.dataset.id;
            const booking = state.bookings.find(b => b.id === bookingId);
            const car = state.cars.find(c => c.id === booking.carId);
            if (!booking || !car) return;

            const printContentEl = document.getElementById('print-area');
            let mapHtml = '';
            if (car.lastParkingLocation) {
                mapHtml = `
                    <div style="position: relative; width: 100%; border: 1px solid #cbd5e1; margin-top: 10px; border-radius: 12px; overflow: hidden;">
                        <img src="${state.parkingMapImage}" style="width: 100%; display: block;">
                        <div style="position: absolute; left: ${car.lastParkingLocation.x}%; top: ${car.lastParkingLocation.y}%; transform: translate(-50%, -100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 40px; height: 40px; color: #db2777; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.3));">
                                <path fill="currentColor" d="M135.2 117.4L109.1 192H402.9l-26.1-74.6C372.3 104.6 360.2 96 346.6 96H165.4c-13.6 0-25.7 8.6-30.2 21.4zM39.6 196.8L74.8 96.3C88.3 57.8 124.6 32 165.4 32H346.6c40.8 0 77.1 25.8 90.6 64.3l35.2 100.5c23.2 9.6 39.6 32.5 39.6 59.2V416c0 35.3-28.7 64-64 64H80c-35.3 0-64-28.7-64-64V256c0-26.7 16.4-49.6 39.6-59.2zM128 288a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zm288 0a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
                            </svg>
                        </div>
                    </div>
                    <p style="text-align: center; font-size: 12px; margin-top: 8px; color: #64748b;">ตำแหน่งจอดล่าสุด ณ ${new Date(car.lastParkingLocation.date).toLocaleString('th-TH')}</p>
                `;
            } else {
                mapHtml = '<div style="border: 2px dashed #cbd5e1; padding: 30px; text-align: center; color: #94a3b8; margin-top: 10px; border-radius: 12px; background-color: #f8fafc;">ไม่มีข้อมูลตำแหน่งจอดล่าสุด</div>';
            }

            printContentEl.innerHTML = `
                <div style="font-family: 'Sarabun', sans-serif; padding: 40px; border: 2px solid #1e293b; line-height: 1.8; color: #1e293b;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px;">
                        <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">ใบขออนุญาตใช้รถยนต์ส่วนกลาง</h2>
                        <p style="font-size: 16px; color: #64748b;">กฟภ. เขต 3 (ภาคกลาง) จ.นครปฐม</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px 30px; font-size: 14px;">
                        <div><strong style="color: #475569;">เลขที่คำสั่ง:</strong> ${booking.orderNumber}</div>
                        <div><strong style="color: #475569;">ทะเบียนรถ:</strong> ${car.license} (${car.name})</div>
                        <div><strong style="color: #475569;">ผู้ขอ:</strong> ${booking.userName}</div>
                        <div><strong style="color: #475569;">แผนก:</strong> ${booking.department}</div>
                        <div style="grid-column: 1 / -1;"><strong style="color: #475569;">เรื่อง:</strong> ${booking.purpose}</div>
                        <div style="grid-column: 1 / -1;"><strong style="color: #475569;">สถานที่:</strong> ${booking.destination}</div>
                        <div><strong style="color: #475569;">เดินทางไป:</strong> ${formatDateTime(booking.startDate, booking.startTime)}</div>
                        <div><strong style="color: #475569;">เดินทางกลับ:</strong> ${formatDateTime(booking.endDate, booking.endTime)}</div>
                    </div>
                    <h3 style="font-size: 16px; font-weight: bold; margin-top: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; color: #475569;">ตำแหน่งจอดรถล่าสุด</h3>
                    ${mapHtml}
                    <div style="margin-top: 60px; display: flex; justify-content: space-around; text-align: center; font-size: 14px;">
                        <div>
                            <p style="margin-bottom: 50px;">.................................................</p>
                            <p style="font-weight: bold;">( ${booking.userName} )</p>
                            <p style="color: #64748b;">ผู้ขออนุญาต</p>
                        </div>
                        <div>
                            <p style="margin-bottom: 50px;">.................................................</p>
                            <p style="font-weight: bold;">( รองผู้อำนวยการฯ )</p>
                            <p style="color: #64748b;">ผู้อนุมัติ</p>
                        </div>
                    </div>
                </div>
            `;

            window.print();
        }
        
        function toggleRole() { 
            state.currentUser.role = state.currentUser.role === 'user' ? 'approver' : 'user';
            state.currentUser.name = state.currentUser.role === 'user' ? 'พนักงานทั่วไป' : 'รองผู้อำนวยการ';
            state.currentUser.id = state.currentUser.role === 'user' ? 'user001' : 'approver001';
            state.currentView = 'dashboard';
            showToast(`เข้าสู่ระบบในฐานะ ${state.currentUser.name}`);
            render();
        };
        
        function switchView(e) {
            state.currentView = e.currentTarget.dataset.view;
            render();
        };

        function handleApproval(e) {
            const id = e.currentTarget.dataset.id;
            const status = e.currentTarget.classList.contains('approve-btn') ? 'approved' : 'rejected';
            const booking = state.bookings.find(b => b.id === id);
            if(booking) {
                booking.status = status;
                showToast(status === 'approved' ? 'อนุมัติคำขอเรียบร้อย' : 'ปฏิเสธคำขอเรียบร้อย', status === 'approved' ? 'success' : 'error');
            }
            render();
        };

        function openCarModal(car = null) {
            carForm.reset();
            if (car) {
                document.getElementById('carModalTitle').textContent = 'แก้ไขข้อมูลรถยนต์';
                document.getElementById('carId').value = car.id;
                document.getElementById('carName').value = car.name;
                document.getElementById('carLicense').value = car.license;
            } else {
                document.getElementById('carModalTitle').textContent = 'เพิ่มรถยนต์ใหม่';
            }
            document.getElementById('carModal').classList.add('active');
        };

        function handleCarFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('carId').value;
            const name = document.getElementById('carName').value;
            const license = document.getElementById('carLicense').value;
            if (id) {
                const car = state.cars.find(c => c.id === id);
                if (car) { car.name = name; car.license = license; }
                showToast('แก้ไขข้อมูลรถยนต์สำเร็จ');
            } else {
                state.cars.push({ id: `c${Date.now()}`, name, license, lastParkingLocation: null });
                showToast('เพิ่มรถยนต์ใหม่สำเร็จ');
            }
            document.getElementById('carModal').classList.remove('active');
            render();
        }

        function handleEditCar(e) {
            const car = state.cars.find(c => c.id === e.currentTarget.dataset.id);
            if(car) openCarModal(car);
        };

        function handleEditParking(e) {
            const carId = e.currentTarget.dataset.id;
            state.editingParkingForCarId = carId;
            state.tempParking.bookingId = null; 
            openParkingModal();
        }

        function handleDeleteCar(e) {
            if(!confirm('ยืนยันการลบรถยนต์?')) return;
            const carId = e.currentTarget.dataset.id;
            state.cars = state.cars.filter(c => c.id !== carId);
            state.bookings.forEach(b => {
                if (b.carId === carId && b.status === 'pending') {
                    b.status = 'rejected';
                }
            });
            showToast('ลบรถยนต์สำเร็จ');
            render();
        };

        function handleParkCar(e) {
            state.tempParking.bookingId = e.currentTarget.dataset.id;
            state.editingParkingForCarId = null;
            openParkingModal();
        };
        
        function openParkingModal() {
            parkingMapImg.src = state.parkingMapImage;
            parkingPin.style.display = 'none';
            document.getElementById('currentMileage').value = '';
            confirmParkingBtn.disabled = true;
            document.getElementById('parkingModal').classList.add('active');
        };
        
        function handleEditBooking(e) {
            const bookingId = e.currentTarget.dataset.id;
            const bookingToEdit = state.bookings.find(b => b.id === bookingId);
            if (bookingToEdit) {
                openBookingModal(bookingToEdit);
            }
        }

        function handleDeleteBooking(e) {
            if(!confirm('ยืนยันการลบคำขอ?')) return;
            const bookingId = e.currentTarget.dataset.id;
            state.bookings = state.bookings.filter(b => b.id !== bookingId);
            showToast('ลบคำขอเรียบร้อย');
            render();
        }

        function handleConfirmParking() {
             if (state.tempParking.location) {
                const carId = state.editingParkingForCarId ? state.editingParkingForCarId : state.bookings.find(b => b.id === state.tempParking.bookingId)?.carId;
                const car = state.cars.find(c => c.id === carId);
                const mileage = document.getElementById('currentMileage').value;

                if(car) {
                    car.lastParkingLocation = {
                        ...state.tempParking.location,
                        date: new Date().toISOString(),
                        mileage: mileage || 'ไม่ระบุ'
                    };
                }

                if (state.tempParking.bookingId) {
                    const booking = state.bookings.find(b => b.id === state.tempParking.bookingId);
                    if (booking) booking.parkingLocation = state.tempParking.location;
                }
                showToast('บันทึกตำแหน่งและเลขไมล์เรียบร้อย');
             }
             
             state.editingParkingForCarId = null;
             state.tempParking.bookingId = null;
             document.getElementById('parkingModal').classList.remove('active');
             render();
        };

        // --- INITIALIZATION ---
        bookingForm.addEventListener('submit', handleBookingFormSubmit);
        carForm.addEventListener('submit', handleCarFormSubmit);
        document.getElementById('closeBookingModalBtn').addEventListener('click', () => document.getElementById('bookingModal').classList.remove('active'));
        document.querySelectorAll('.booking-datetime-picker').forEach(el => el.addEventListener('change', updateAvailableCars));
        closeDetailsModalBtn.addEventListener('click', () => document.getElementById('detailsModal').classList.remove('active'));
        
        confirmParkingBtn.addEventListener('click', handleConfirmParking);
        parkingMapContainer.addEventListener('click', (e) => {
             const rect = parkingMapContainer.getBoundingClientRect();
             const x = ((e.clientX - rect.left) / rect.width) * 100;
             const y = ((e.clientY - rect.top) / rect.height) * 100;
             state.tempParking.location = { x, y };
             parkingPin.style.left = `${x}%`;
             parkingPin.style.top = `${y}%`;
             parkingPin.style.display = 'block';
             confirmParkingBtn.disabled = false;
        });

        [bookingModal, carModal, parkingModal, detailsModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        });
        document.getElementById('closeCarModalBtn').addEventListener('click', () => document.getElementById('carModal').classList.remove('active'));
        document.getElementById('closeParkingModalBtn').addEventListener('click', () => document.getElementById('parkingModal').classList.remove('active'));

        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
